## 概念
### 简介
简介：Apache ZooKeeper是一种分布式应用程序的高性能协调服务，提供集中式信息存储服务。  
特点：数据存在内存中，类似文件系统的树形结构（文件和目录），高吞吐量和低延时，集群高可靠。  
作用：基于zookeeper可实现分布式统一配置中心、服务注册中心、分布式锁等功能的实现。

### 数据模型
#### 层次名称空间
- 类似 unix 文件系统，以 / 为根。
- 节点可以包含与之关联的数据以及子节点。
- 节点的路径总是表示为规范的、绝对的、斜杠分隔的路径。

#### Znode
- 名称唯一，命名规范。
- 节点类型：持久、顺序、临时、临时顺序。
- 节点数据构成。
- 操作的Znode的数据大小限制为1M。

## 特性
- 顺序一致性，保证客户端操作都是顺序生效的；
- 原子性，更新成功或失败。没有部分结果；
- 单个系统映像，无论连接到那个服务器，客户端都将看到相同的内容；
- 可靠性，数据变更不会丢失，除非被客户端覆盖修改；
- 及时性，保证系统的客户段当时读取到的数据是最新的；

## 机制
### 会话机制
- 一个客户端连接一个会话，由 zk 分配唯一会话 id。
- 客户端以特定时间间隔发送心跳以保持会话有效。
- 超时时间未收到客户端的心跳，则判断客户端死了。（默认两倍的 tickTime）
- 会话中的请求按 FIFO 顺序执行。

### Watch机制
- 一次性触发：watch 触发后即被删除。要持续监控变化，则需要持续设置 watch。
- 有序性：客户端先得到 watch 通知，后才会看到变化结果。

### 节点权限
#### ACL 权限控制
使用：`scheme:id:perm` 来标识，主要涵盖 3 个方面：
- 权限模式（Scheme）：授权的策略
- 授权对象（ID）:授权的对象
- 权限（Permission）:授予的权限

#### scheme  采用何种方式授权
- world：默认方式，相当于全部都能访问。
- auth：代表已经认证通过的用户。
- digest：即用户名:密码这种方式认证，这也是业务系统中最常用的。
- ip：使用客户端的主机IP作为ACL ID。
  
#### ID 给谁授予权限

#### permission 授予什么权限
- CREATE c 可以创建子节点
- DELETE d 可以删除子节点（仅下一级节点）
- READ r 可以读取节点数据及显示子节点列表
- WRITE w 可以设置节点数据
- ADMIN a 可以设置节点访问控制列表权限
  
## 使用
### 配置
```
tickTime=2000					# CS通信心跳时间 
dataDir=/var/lib/zookeeper/		# 该属性对应的目录是用来存放myid信息跟一些版本，日志，跟服务器唯一的ID信息等。
clientPort=2181					# 客户端连接的接口，客户端连接zookeeper服务器的端口
initLimit=5						# 集群中的follower服务器(F)与leader服务器(L)之间初始连接时能容忍的最多心跳数（tickTime的数量）。
syncLimit=2						# 集群中flower服务器（F）跟leader（L）服务器之间的请求和答应最多能容忍的心跳数。
server.1=zoo1:2888:3888			# 节点信息，server.{myid}={节点地址}:{内部通信端口}:{leader 选举端口}
server.2=zoo2:2888:3888
server.3=zoo3:2888:3888
```

### ZkClient
### Apache Curator

## 原理
### ZAB 协议
1. 所有事务请求转发给 leader；
1. Leader 分配全局单调递增事务 id（Zxid），广播事务提议；
1. Follower 处理提议，做出反馈；
1. Leader 收到过半数反馈，广播 Commit；
1. Follower 做出响应；

### Leader 选举
具有最高 ZXID 的事务 Proposal 的机器成为Leader。

### 崩溃恢复
Leader 服务器出现崩溃，或者说由于网络原因导致 Leader 服务器失去了与过半 Follower 的联系，那么就会进入崩溃回复模式。

### 数据同步
Leader 服务器会为每个 Follower 服务器都准备一个队列，进行数据同步，当半数 Followers 完成同步，则可以开始提供服务。

### 丢弃事务 Proposal 处理
当一个包含了上一个 Leader 周期中尚未提交过的事务 Proposal 的服务器加入集群，Leader 会要求 Follower 回退到一个确实已经被集群中过半机器提交的最新的事务 Proposal。

## 应用
### 配置中心
### 分布式锁
### 分布式队列
### Leader 选举
### 注册中心